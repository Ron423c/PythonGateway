Python Gateway в InterSystems IRIS

Эта серия статей будет посвящена Python Gateway - комьюнити проекту с открытым исходных кодом для платформы данных InterSystems IRIS. Этот проект 
добавит все возможности Python прямо в вашу среду InterSystems IRIS, позволяя:

- Выполнять произвольный код на Python
- Передавать данные из InterSystems IRIS в Python и обратно
- Добавлять Python код в ваши интеллектуальные бизнес-процессы с помощью Python адаптера
- Сохранять, исследовать, изменять и восстановливать контекст Python из InterSystems IRIS
- И многое другое...

# План

# Введение

Машинное обучение (ML) - класс методов искусственного интеллекта, характерной чертой которых является не прямое решение задачи, а обучение в процессе применения решений множества сходных задач. 

Алгоритмы и модели машинного обучения становятся все более распространенными. Причин тому множество, но все сводится к доступности, 
простоте и достижению практических результатов. Является ли кластеризация или даже нейросетевое моделирование новой технологией? 
Конечно нет, но в настоящее время нет необходимости писать сотни тысяч строк кода, чтобы запустить одну, а затраты на создание и применение моделей становятся всё меньше и меньше.

Инструменты развиваются - в то время как в настоящее время у нас нет полностью GUI-ориентированных AI/ML инструментов, но тот же прогресс, который мы наблюдали со многими другими классами информаионных систем, например BI (от написания кода до 
использования фреймворков и GUI-ориентированных конфигурируемых решений), наблюдается и в инструментах для создания AI/ML. Мы уже прошли этап написания кода и в настоящее время используем фреймворки для построени и обучения моделей.

Другие улучшения, например предоставление предобученной модели, когда конечный пользователь должен просто закончить обучение модели на его специфических данных также упрощает процесс настройки. Эти достижения значительно облегчают изучение машинного обучения как непосредственно для специалистов, так и для компаний в целом.

С другой стороны, в настоящее время мы собираем всё больше данных о каждой транзакции. Благодаря унифицированной платформе данных, такой как InterSystems IRIS, вся эта информация может быть немедленно получена и использована в качестве исходных данных для прогнозных моделей.

С облаком, запуск AI/ML проектов становится легче, чем когда-либо. Мы можем потреблять только те ресурсы, которые нам необходимы. Более того, благодаря параллелизации, предлагаемому облачными платформами, мы можем сэкономить затрачиваемое время.

Но как насчет результатов? Здесь все становится немного сложнее. 
Существует множество инструментов для построения модели, о которых я расскажу далее, и построить хорошую модель не просто, но что 
дальше? Получение прибыли от использования модели бизнесом также является нетривиальной задачей. 
Корень проблемы - разделение аналитических и транзакционных потоков и моделей данных. Когда мы обучаем модель, мы обычно делаем это на исторических данных. Но место для построенной модели - в транзакционной обработке данных. Что хорошего в лучшей модели обнаружения мошеннических транзакций, если мы запускаем ее раз в день? Преступники уже давно ушли с деньгами. Нам нужно тренировать модель на исторических данных, но мы также должны применять модель в реальном времени на новых поступающих данных, чтобы 
наши бизнес-процессы могли действовать в соответствии с прогнозами, сделанными моделью.

# MLToolkit

MLToolkit - набор инструментов, целью которого является именно это - объединение моделей и транзакционной среды, чтобы построенные вами модели можно было легко использовать прямо в ваших бизнес-процессах. Python Gateway является частью MLToolkit и обеспечивает интеграцию с языком Python (аналогично как R Gateway обеспечивает интеграцию с языком R).

# Ландшафт

Прежде чем мы продолжим, я хотел бы описать несколько инструментов и библиотек для Python, которые мы будем использовать позже.

## Инструменты

- Python - интерпретируемый, высокоуровневый язык программирования общего назначения. Основным преимуществом языка является большая библиотека математических, ML и AI библиотек. Как и ObjectScript, это объектно-ориентированный язык, но всё динамически, а не статично. Также все является объектом. Более поздние статьи предполагают мимолетное знакомство с языком. Если вы хотите начать обучение, я рекомендую начать с [документации](https://docs.python.org/3.6/tutorial/index.html).
- Для наших последующих упражнений установите [Python 3.6.7 64 bit](https://www.python.org/downloads/release/python-367/).
- IDE: Я использую [PyCharm](https://www.jetbrains.com/pycharm/), но вообще их [много](https://realpython.com/python-ides-code-editors-guide/). Если вы используете Atelier, то существует Eclipse для разработчиков Python. Если вы используете VS Code, то существует расширение для Python. 
- Notebook: вместо IDE вы можете писать и делиться своими скриптами в онлайн ноутбуках. Самый популярный из них - [Jupyter](https://jupyter.org/).

## Библиотеки

Вот (неполный) список библиотек для машинного обучения:

- [Numpy](http://www.numpy.org/) - фундаментальный пакет для точных вычислений.
- [Pandas](http://pandas.pydata.org/) - высокопроизводительные структуры данных и инструменты анализа данных.
- [Matplotlib](https://matplotlib.org/) - создание графиков.
- [Seaborn](https://seaborn.pydata.org/) - визуализация данных, основанная на matplotlib.
- [Sklearn](https://scikit-learn.org/stable/) - методы машинного обучения.
- [XGBoost](https://xgboost.readthedocs.io/en/latest/index.html) - алгоритмы машинного обучения в рамках методологии градиентного бустинга (Gradient Boosting).
- [Gensim](https://radimrehurek.com/gensim/) - NLP.
- [Keras](https://keras.io/) - нейронные сети.
- [Tensorflow](https://www.tensorflow.org/) - платформа для создания моделей машинного обучения.
- [PyTorch](https://pytorch.org/) - платформа для создания моделей машинного обученияб ориентированная на Python.
- [Nyoka](https://github.com/nyoka-pmml/nyoka) - PMML из различных моделей.

Технологии AI/ML позволяют сделать бизнес более эффективным и адаптируемым.  Более того, сегодня эти технологии становятся проще в разработке и внедрении. Начните изучать AI/ML технологии и то, как они могут помочь вашей организации расти.


# Установка

Существует несколько способов установки и использования Python Gateway:

- ОС
  - Windows
  - Linux
  - Mac
- Docker
  - Используйте образ из DockerGub
  - Создайте свой собственный образ
  
Независимо от способа установки, вам понадобится исходный код. Единственное место для скачивания кода - [страница релизов](https://github.com/intersystems-community/PythonGateway/releases). Она содержит протестированные стабильные релизы, просто берите последний. На данный момент это 0.8, но со временем будут и новые. Не клонируйте/загружайте репозиторий, скачайте последний релиз.

# ОС
  
Если вы устанавливаете Python Gateway в операционную систему, то сначала (вне зависимости от операционной системы) вам необходимо установить Python. Для этого:
  
1. [Установить Python 3.6.7 64 bit](https://www.python.org/downloads/release/python-367/). Рекомендуется установить Python в директорию по-умолчанию.
2. Установите модуль `dill`: `pip install dill`.
3. Загрузите код ObjectScript (т.е. `do $system.OBJ.ImportDir("C:\InterSystems\Repos\Python\isc\py\", "*.cls", "c",,1)`) в любую область с продукциями. В случае, если вы хотите, чтобы существующая область поддерживала продукции, выполните: `write ##class(%EnsembleMgr).EnableNamespace($Namespace, 1)`.
4. Поместите [callout DLL/SO/DYLIB](https://github.com/intersystems-community/PythonGateway/releases) в папку `bin` вашего инстанса InterSystems IRIS. Файл библиотеки должен быть доступен по пути, возвращаемом `write ##class(isc.py.Callout).GetLib()`. 

## Windows 

5. Убедитесь, что переменная окружения `PYTHONHOME` указывает на Python 3.6.7.
6. Убедитесь, что системная переменная окружения `PATH` содержит переменную `PYTHONHOME` (или директорию, на которую она указывает).

## Linux (Debian/Ubuntu)

5. Проверьте, что переменная окружения `PATH` содержит `/usr/lib` и `/usr/lib/x86_64-linux-gnu`. Используйте файл `/etc/environment` для установки переменных окружения.
6. В случае ошибок `undefined symbol: _Py_TrueStruct` установите настройку `PythonLib`. Также в [Readme](https://github.com/intersystems-community/PythonGateway) есть раздел Troubleshooting.

## Mac

5. В настоящее время поддерживается только питон 3.6.7 из [Python.org](https://www.python.org/downloads/release/python-367/). Проверьте переменную `PATH`.

Если вы изменяли переменные окружения, перезапустите ваш продукт InterSystems.

# Docker

Использование контейнеров имеет ряд преимуществ: 
- Портативность
- Эффективность
- Изоляция
- Легковесность
- Иммутабельность

Ознакомьтесь с этой [серией статей](https://community.intersystems.com/post/continuous-delivery-your-intersystems-solution-using-gitlab-part-v-why-containers) для получения более подробной информации об использовании Docker с продуктами InterSystems. 

Все сборки Python Gateway на данный момент основаны на контейнерах `2019.4`.

## Готовый образ

Выполните: `docker run -d -p 52773:52773 --name irispy intersystemscommunity/irispy-community:latest`, чтобы загрузить и запустить Python Gateway с InterSystems IRIS Community Edition. Вот и все.

## Создайте свой собственный образ

Для сборки докер образа выполните в корне репозитория: `docker build --force-rm --tag intersystemscommunity/irispy:latest .`. 
По умолчанию образ собирается на основе образа `store/intersystems/iris-community:2019.4.0.383.0`, однако вы можете изменить это, установив переменную `IMAGE`.
Для сборки из InterSystems IRIS выполните: `docker build --build-arg IMAGE=store/intersystems/iris:2019.4.0.383.0 --force-rm --tag intersystemscommunity/irispy:latest ``.

После этого вы можете запустить докер образ:

```
docker run -d \
  -p 52773:52773 \
  -v /<HOST-DIR-WITH-iris.key>/:/mount \
  --name irispy \
  intersystemscommunity/irispy:latest \
  --key /mount/iris.key
```

Если вы используете образ, основанный на InterSystems IRIS Community Edition, вы можете не указывать ключ.

## Docker - комментарии

- Тетсовый процесс `isc.py.test.Process` сохраняет ряд изображений во временный каталог. Возможно, вы захотите изменить этот путь на смонтированный каталог. Для этого отредактируйте настройку `WorkingDir` указав смонтированную директорию.
- Для доступа к терминалу выполните: `docker exec -it irispy sh`.
- Доступ к Порталу Управления Системой по логину `SuperUser`/`SYS`.
- Чтобы остановить контейнер, выполните: `docker stop irispy && docker rm --force irispy`.

# Проверка установки

После того, как вы установили Python Gateway стоит проверить, что он работает. Выполните этот код в терминале InterSystems IRIS:
```
set sc = ##class(isc.py.Callout).Setup() 
set sc = ##class(isc.py.Main).SimpleString("x='HELLO'", "x", , .var).
write var
```

В результате на экране должно быть выведено `HELLO` - значение переменной Python `x`. Если возвращаемый статус `sc` является ошибкой или `var` пустое, проверьте [Readme - Troubleshooting section](https://github.com/intersystems-community/PythonGateway).
